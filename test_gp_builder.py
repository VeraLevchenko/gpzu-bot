#!/usr/bin/env python3
# test_gp_builder.py
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –≥—Ä–∞–¥–ø–ª–∞–Ω–∞.
"""

import json
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.insert(0, '/home/vs/projects/gpzu-bot')

from generator.gp_builder import GPBuilder

# –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
test_data = {
    "application": {
        "number": "‚Ññ123-2024",
        "date": "15.01.2024",
        "applicant": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
        "purpose": "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∂–∏–ª–∏—â–Ω–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"
    },
    "parcel": {
        "cadnum": "42:30:0207052:95",
        "area": "2382",
        "address": "–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –≥. –ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫, —É–ª. –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è, –¥. 36",
        "region": "–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "municipality": "–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∏–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥",
        "settlement": "",
        "permitted_use": "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∂–∏–ª–∏—â–Ω–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ",
        "coordinates": [
            {"num": "1", "x": "2199812.21", "y": "438312.84"},
            {"num": "2", "x": "2199850.33", "y": "438315.92"},
            {"num": "3", "x": "2199848.44", "y": "438340.11"},
            {"num": "4", "x": "2199810.55", "y": "438337.22"}
        ]
    },
    "zone": {
        "code": "–û–î-1",
        "name": "–ó–æ–Ω–∞ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ-–¥–µ–ª–æ–≤–æ–≥–æ –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
        "vri_main": [],
        "vri_conditional": [],
        "parameters": {}
    },
    # 3 –æ–±—ä–µ–∫—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª—å–Ω–æ–≥–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
    "capital_objects": [
        {
            "cadnum": "42:30:010101:123",
            "name": "–ñ–∏–ª–æ–π –¥–æ–º",
            "area": "120.5",
            "floors": "2"
        },
        {
            "cadnum": "42:30:020202:456",
            "name": "–ì–∞—Ä–∞–∂",
            "area": "32.0",
            "floors": "1"
        },
        {
            "cadnum": "42:30:030303:789",
            "name": "–°–∞—Ä–∞–π",
            "area": "15.0",
            "floors": "1"
        }
    ],
    # 4 –ó–û–£–ò–¢: –ø—Ä–∏–∞—ç—Ä–æ–¥—Ä–æ–º–Ω–∞—è, —á–µ—Ç–≤–µ—Ä—Ç–∞—è –ø–æ–¥–∑–æ–Ω–∞, –°–ó–ó, –∑–æ–Ω–∞ –í–õ
    "zouit": [
        {
            "name": "–ü—Ä–∏–∞—ç—Ä–æ–¥—Ä–æ–º–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –∞—ç—Ä–æ–¥—Ä–æ–º–∞ –ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫ (–°–ø–∏—á–µ–Ω–∫–æ–≤–æ)",
            "registry_number": "42:00-6.1695",
            "area": "2382",
            "document": "–ü—Ä–∏–∫–∞–∑ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –≤–æ–∑–¥—É—à–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –æ—Ç 22.04.2020 ‚Ññ409-–ü",
            "restrictions": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å—Ç–∞—Ç—å—ë–π 64 –ü—Ä–∞–≤–∏–ª –∑–µ–º–ª–µ–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –∑–∞—Å—Ç—Ä–æ–π–∫–∏ –ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–æ–≥–æ –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –æ–∫—Ä—É–≥–∞."
        },
        {
            "name": "–ß–µ—Ç–≤–µ—Ä—Ç–∞—è –ø–æ–¥–∑–æ–Ω–∞ –ø—Ä–∏–∞—ç—Ä–æ–¥—Ä–æ–º–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∞—ç—Ä–æ–¥—Ä–æ–º–∞ –ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫ (–°–ø–∏—á–µ–Ω–∫–æ–≤–æ)",
            "registry_number": "42:00-6.1698",
            "area": "2382",
            "document": "–ü—Ä–∏–∫–∞–∑ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –≤–æ–∑–¥—É—à–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –æ—Ç 22.04.2020 ‚Ññ409-–ü",
            "restrictions": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö —á–µ—Ç–≤–µ—Ä—Ç–æ–π –ø–æ–¥–∑–æ–Ω—ã –ø—Ä–∏–∞—ç—Ä–æ–¥—Ä–æ–º–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏."
        },
        {
            "name": "–°–∞–Ω–∏—Ç–∞—Ä–Ω–æ-–∑–∞—â–∏—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è",
            "registry_number": "42:30-6.0001",
            "area": "1500",
            "document": "–ü—Ä–æ–µ–∫—Ç —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-–∑–∞—â–∏—Ç–Ω–æ–π –∑–æ–Ω—ã, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –†–æ—Å–ø–æ—Ç—Ä–µ–±–Ω–∞–¥–∑–æ—Ä–∞",
            "restrictions": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ —Ü–µ–ª—è—Ö —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-—ç–ø–∏–¥–µ–º–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π."
        },
        {
            "name": "–û—Ö—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞ –í–õ 110 –∫–í",
            "registry_number": "42:30-6.0002",
            "area": "800",
            "document": "–ü—Ä–∞–≤–∏–ª–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —ç–ª–µ–∫—Ç—Ä–æ—É—Å—Ç–∞–Ω–æ–≤–æ–∫, –∏–Ω—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–æ–≤—ã–µ –∞–∫—Ç—ã",
            "restrictions": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–∞–Ω—ã —Å –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –≤–æ–∑–¥—É—à–Ω–æ–π –ª–∏–Ω–∏–∏ —ç–ª–µ–∫—Ç—Ä–æ–ø–µ—Ä–µ–¥–∞—á–∏."
        }
    ],
    # –ö–∞–∫ –±—É–¥—Ç–æ –Ω–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
    "planning_projects": {
        "has_projects": True,
        "decision_full": (
            "–ò–º–µ–µ—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ –æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –ø—Ä–æ–µ–∫—Ç–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ –∏ –º–µ–∂–µ–≤–∞–Ω–∏—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏, "
            "—É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–µ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Ä–æ–¥–∞ –ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞ –æ—Ç 10.10.2024 ‚Ññ123-–ø–∞."
        )
    }
}


def test_gp_builder():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –≥—Ä–∞–¥–ø–ª–∞–Ω–∞"""
    
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ì–ï–ù–ï–†–ê–¢–û–†–ê –ì–†–ê–î–ü–õ–ê–ù–ê\n")
    print("=" * 80)
    
    # –ü—É—Ç–∏
    template_path = "/home/vs/projects/gpzu-bot/templates/gpzu_template.docx"
    output_path = "/tmp/test_gradplan.docx"
    
    print(f"\nüìÑ –®–∞–±–ª–æ–Ω: {template_path}")
    print(f"üìù –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {output_path}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —à–∞–±–ª–æ–Ω–∞
    if not Path(template_path).exists():
        print(f"\n‚ùå –û–®–ò–ë–ö–ê: –®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return False
    
    print("\n‚úÖ –®–∞–±–ª–æ–Ω –Ω–∞–π–¥–µ–Ω")
    
    # –°–æ–∑–¥–∞—ë–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
    try:
        builder = GPBuilder(template_path, data_dir="/home/vs/projects/gpzu-bot/data")
        print("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        return False
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ó–û–£–ò–¢
    print("\n" + "=" * 80)
    print("\nüîç –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –§–ê–ô–õ–û–í –ó–û–£–ò–¢:\n")
    
    test_zouit_names = [
        "–ü—Ä–∏–∞—ç—Ä–æ–¥—Ä–æ–º–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –∞—ç—Ä–æ–¥—Ä–æ–º–∞ –ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫ (–°–ø–∏—á–µ–Ω–∫–æ–≤–æ)",
        "–ß–µ—Ç–≤–µ—Ä—Ç–∞—è –ø–æ–¥–∑–æ–Ω–∞ –ø—Ä–∏–∞—ç—Ä–æ–¥—Ä–æ–º–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏",
        "–û—Ö—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞ –æ–±—ä–µ–∫—Ç–æ–≤ —ç–ª–µ–∫—Ç—Ä–æ—Å–µ—Ç–µ–≤–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞",
        "–°–∞–Ω–∏—Ç–∞—Ä–Ω–æ-–∑–∞—â–∏—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è",
        "–û—Ö—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞ –≥–∞–∑–æ–ø—Ä–æ–≤–æ–¥–∞"
    ]
    
    for name in test_zouit_names:
        filename = builder.get_zouit_file(name)
        status = "‚úÖ" if filename else "‚ö†Ô∏è"
        print(f"{status} {name[:60]:60s} ‚Üí {filename}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –±–ª–æ–∫–æ–≤ –∑–æ–Ω
    print("\n" + "=" * 80)
    print("\nüìÇ –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ë–õ–û–ö–û–í –ó–û–ù:\n")
    
    zone_code = test_data['zone']['code']
    
    vri_file = builder.tz_dir / f"{zone_code}_vri.docx"
    params_file = builder.tz_dir / f"{zone_code}.docx"
    
    print(f"–í–†–ò –∑–æ–Ω—ã {zone_code}:      {vri_file}")
    print(f"  –°—É—â–µ—Å—Ç–≤—É–µ—Ç: {'‚úÖ –î–∞' if vri_file.exists() else '‚ùå –ù–µ—Ç'}")
    
    print(f"\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–æ–Ω—ã {zone_code}: {params_file}")
    print(f"  –°—É—â–µ—Å—Ç–≤—É–µ—Ç: {'‚úÖ –î–∞' if params_file.exists() else '‚ùå –ù–µ—Ç'}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ó–û–£–ò–¢
    print("\n" + "=" * 80)
    print("\nüìÇ –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ë–õ–û–ö–û–í –ó–û–£–ò–¢:\n")
    
    for zouit in test_data['zouit']:
        filename = builder.get_zouit_file(zouit['name'])
        if filename:
            filepath = builder.zouit_dir / filename
            exists = filepath.exists()
            status = "‚úÖ" if exists else "‚ùå"
            print(f"{status} {zouit['name'][:50]}")
            print(f"    ‚Üí {filename} ({'–Ω–∞–π–¥–µ–Ω' if exists else '–Ω–µ –Ω–∞–π–¥–µ–Ω'})")
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    print("\n" + "=" * 80)
    print("\nüî® –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–ê:\n")
    
    try:
        result_path = builder.generate(test_data, output_path)
        print(f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: {result_path}")
        print(f"\nüìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {Path(result_path).stat().st_size / 1024:.1f} –ö–ë")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    print("\n")
    success = test_gp_builder()
    print("\n" + "=" * 80)
    
    if success:
        print("\n‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù –£–°–ü–ï–®–ù–û!")
        print("\nüìÇ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: /tmp/test_gradplan.docx")
        print("   –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª—ã 4, 5 –∏ —Ç–∞–±–ª–∏—Ü—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.")
    else:
        print("\n‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù")
        print("\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("  ‚Ä¢ –®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        print("  ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã –±–ª–æ–∫–æ–≤")
        print("  ‚Ä¢ –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö")
    
    print("\n")
